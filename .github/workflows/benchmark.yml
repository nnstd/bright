name: Benchmark

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  benchmark:
    name: Performance Benchmark
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      
      - name: Install dependencies
        run: |
          go mod download
          brew install jq
      
      - name: Make benchmark script executable
        run: chmod +x benchmark.sh
      
      - name: Run benchmark
        id: benchmark
        run: |
          ./benchmark.sh | tee benchmark_output.txt
      
      - name: Extract results
        id: results
        run: |
          # Get the latest result file
          RESULT_FILE=$(ls -t benchmark_results/*.json | head -1)
          
          # Extract metrics
          BRIGHT_INDEX=$(jq -r '.bright.indexing_ms' $RESULT_FILE)
          BRIGHT_SEARCH=$(jq -r '.bright.avg_search_ms' $RESULT_FILE)
          MEILI_INDEX=$(jq -r '.meilisearch.indexing_ms' $RESULT_FILE)
          MEILI_SEARCH=$(jq -r '.meilisearch.avg_search_ms' $RESULT_FILE)
          
          # Set outputs
          echo "bright_index=$BRIGHT_INDEX" >> $GITHUB_OUTPUT
          echo "bright_search=$BRIGHT_SEARCH" >> $GITHUB_OUTPUT
          echo "meili_index=$MEILI_INDEX" >> $GITHUB_OUTPUT
          echo "meili_search=$MEILI_SEARCH" >> $GITHUB_OUTPUT
          
          # Calculate percentages
          if [ $BRIGHT_INDEX -lt $MEILI_INDEX ]; then
            INDEX_DIFF=$(( (MEILI_INDEX - BRIGHT_INDEX) * 100 / MEILI_INDEX ))
            echo "index_winner=Bright ($INDEX_DIFF% faster)" >> $GITHUB_OUTPUT
          else
            INDEX_DIFF=$(( (BRIGHT_INDEX - MEILI_INDEX) * 100 / BRIGHT_INDEX ))
            echo "index_winner=Meilisearch ($INDEX_DIFF% faster)" >> $GITHUB_OUTPUT
          fi
          
          if [ $BRIGHT_SEARCH -lt $MEILI_SEARCH ]; then
            SEARCH_DIFF=$(( (MEILI_SEARCH - BRIGHT_SEARCH) * 100 / MEILI_SEARCH ))
            echo "search_winner=Bright ($SEARCH_DIFF% faster)" >> $GITHUB_OUTPUT
          else
            SEARCH_DIFF=$(( (BRIGHT_SEARCH - MEILI_SEARCH) * 100 / BRIGHT_SEARCH ))
            echo "search_winner=Meilisearch ($SEARCH_DIFF% faster)" >> $GITHUB_OUTPUT
          fi
      
      - name: Create benchmark comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const brightIndex = '${{ steps.results.outputs.bright_index }}';
            const brightSearch = '${{ steps.results.outputs.bright_search }}';
            const meiliIndex = '${{ steps.results.outputs.meili_index }}';
            const meiliSearch = '${{ steps.results.outputs.meili_search }}';
            const indexWinner = '${{ steps.results.outputs.index_winner }}';
            const searchWinner = '${{ steps.results.outputs.search_winner }}';
            
            const comment = `## Performance Benchmark Results
            
            | Metric | Bright | Meilisearch | Winner |
            |--------|--------|-------------|--------|
            | **Indexing** | ${brightIndex}ms | ${meiliIndex}ms | ${indexWinner} |
            | **Avg Search** | ${brightSearch}ms | ${meiliSearch}ms | ${searchWinner} |
            
            <details>
            <summary>Test Configuration</summary>
            
            - **Dataset**: 1,000 product documents
            - **Search Queries**: laptop, computer, complex filter
            - **Platform**: Linux AMD64
            - **Meilisearch Version**: v1.31.0
            
            </details>
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            benchmark_results/
            benchmark_output.txt
          retention-days: 30
      
      - name: Comment on commit
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const brightIndex = '${{ steps.results.outputs.bright_index }}';
            const brightSearch = '${{ steps.results.outputs.bright_search }}';
            const meiliIndex = '${{ steps.results.outputs.meili_index }}';
            const meiliSearch = '${{ steps.results.outputs.meili_search }}';
            const indexWinner = '${{ steps.results.outputs.index_winner }}';
            const searchWinner = '${{ steps.results.outputs.search_winner }}';
            
            const comment = `**Benchmark Results** (vs Meilisearch v1.31.0)
            - Indexing: Bright ${brightIndex}ms vs Meili ${meiliIndex}ms - ${indexWinner}
            - Search: Bright ${brightSearch}ms vs Meili ${meiliSearch}ms - ${searchWinner}`;
            
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: comment
            });
