name: Benchmark

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  benchmark:
    name: Performance Benchmark
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      
      - name: Install dependencies
        run: |
          go mod download
          # Install jq if not already present
          if ! command -v jq &> /dev/null; then
            sudo apt-get update || true
            sudo apt-get install -y jq || sudo snap install jq || echo "jq installation failed, using alternative JSON parsing"
          fi
      
      - name: Make benchmark script executable
        run: chmod +x benchmark.sh
      
      - name: Run benchmark
        id: benchmark
        run: |
          ./benchmark.sh | tee benchmark_output.txt
      
      - name: Extract results
        id: results
        run: |
          # Get the latest result file
          RESULT_FILE=$(ls -t benchmark_results/*.json | head -1)
          
          # Extract metrics for all dataset sizes
          BRIGHT_1K_IDX=$(jq -r '.results."1000".bright.indexing_ms' $RESULT_FILE)
          BRIGHT_1K_SEARCH=$(jq -r '.results."1000".bright.search_ms' $RESULT_FILE)
          BRIGHT_1K_MEM=$(jq -r '.results."1000".bright.memory_mb' $RESULT_FILE)
          MEILI_1K_IDX=$(jq -r '.results."1000".meilisearch.indexing_ms' $RESULT_FILE)
          MEILI_1K_SEARCH=$(jq -r '.results."1000".meilisearch.search_ms' $RESULT_FILE)
          MEILI_1K_MEM=$(jq -r '.results."1000".meilisearch.memory_mb' $RESULT_FILE)
          
          BRIGHT_5K_IDX=$(jq -r '.results."5000".bright.indexing_ms' $RESULT_FILE)
          BRIGHT_5K_SEARCH=$(jq -r '.results."5000".bright.search_ms' $RESULT_FILE)
          BRIGHT_5K_MEM=$(jq -r '.results."5000".bright.memory_mb' $RESULT_FILE)
          MEILI_5K_IDX=$(jq -r '.results."5000".meilisearch.indexing_ms' $RESULT_FILE)
          MEILI_5K_SEARCH=$(jq -r '.results."5000".meilisearch.search_ms' $RESULT_FILE)
          MEILI_5K_MEM=$(jq -r '.results."5000".meilisearch.memory_mb' $RESULT_FILE)
          
          BRIGHT_10K_IDX=$(jq -r '.results."10000".bright.indexing_ms' $RESULT_FILE)
          BRIGHT_10K_SEARCH=$(jq -r '.results."10000".bright.search_ms' $RESULT_FILE)
          BRIGHT_10K_MEM=$(jq -r '.results."10000".bright.memory_mb' $RESULT_FILE)
          MEILI_10K_IDX=$(jq -r '.results."10000".meilisearch.indexing_ms' $RESULT_FILE)
          MEILI_10K_SEARCH=$(jq -r '.results."10000".meilisearch.search_ms' $RESULT_FILE)
          MEILI_10K_MEM=$(jq -r '.results."10000".meilisearch.memory_mb' $RESULT_FILE)
          
          # Set outputs
          echo "bright_1k_idx=$BRIGHT_1K_IDX" >> $GITHUB_OUTPUT
          echo "bright_1k_search=$BRIGHT_1K_SEARCH" >> $GITHUB_OUTPUT
          echo "bright_1k_mem=$BRIGHT_1K_MEM" >> $GITHUB_OUTPUT
          echo "meili_1k_idx=$MEILI_1K_IDX" >> $GITHUB_OUTPUT
          echo "meili_1k_search=$MEILI_1K_SEARCH" >> $GITHUB_OUTPUT
          echo "meili_1k_mem=$MEILI_1K_MEM" >> $GITHUB_OUTPUT
          
          echo "bright_5k_idx=$BRIGHT_5K_IDX" >> $GITHUB_OUTPUT
          echo "bright_5k_search=$BRIGHT_5K_SEARCH" >> $GITHUB_OUTPUT
          echo "bright_5k_mem=$BRIGHT_5K_MEM" >> $GITHUB_OUTPUT
          echo "meili_5k_idx=$MEILI_5K_IDX" >> $GITHUB_OUTPUT
          echo "meili_5k_search=$MEILI_5K_SEARCH" >> $GITHUB_OUTPUT
          echo "meili_5k_mem=$MEILI_5K_MEM" >> $GITHUB_OUTPUT
          
          echo "bright_10k_idx=$BRIGHT_10K_IDX" >> $GITHUB_OUTPUT
          echo "bright_10k_search=$BRIGHT_10K_SEARCH" >> $GITHUB_OUTPUT
          echo "bright_10k_mem=$BRIGHT_10K_MEM" >> $GITHUB_OUTPUT
          echo "meili_10k_idx=$MEILI_10K_IDX" >> $GITHUB_OUTPUT
          echo "meili_10k_search=$MEILI_10K_SEARCH" >> $GITHUB_OUTPUT
          echo "meili_10k_mem=$MEILI_10K_MEM" >> $GITHUB_OUTPUT
      
      - name: Create benchmark comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const b1kIdx = '${{ steps.results.outputs.bright_1k_idx }}';
            const b5kIdx = '${{ steps.results.outputs.bright_5k_idx }}';
            const b10kIdx = '${{ steps.results.outputs.bright_10k_idx }}';
            const m1kIdx = '${{ steps.results.outputs.meili_1k_idx }}';
            const m5kIdx = '${{ steps.results.outputs.meili_5k_idx }}';
            const m10kIdx = '${{ steps.results.outputs.meili_10k_idx }}';
            
            const b1kSearch = '${{ steps.results.outputs.bright_1k_search }}';
            const b5kSearch = '${{ steps.results.outputs.bright_5k_search }}';
            const b10kSearch = '${{ steps.results.outputs.bright_10k_search }}';
            const m1kSearch = '${{ steps.results.outputs.meili_1k_search }}';
            const m5kSearch = '${{ steps.results.outputs.meili_5k_search }}';
            const m10kSearch = '${{ steps.results.outputs.meili_10k_search }}';
            
            const b1kMem = '${{ steps.results.outputs.bright_1k_mem }}';
            const b5kMem = '${{ steps.results.outputs.bright_5k_mem }}';
            const b10kMem = '${{ steps.results.outputs.bright_10k_mem }}';
            const m1kMem = '${{ steps.results.outputs.meili_1k_mem }}';
            const m5kMem = '${{ steps.results.outputs.meili_5k_mem }}';
            const m10kMem = '${{ steps.results.outputs.meili_10k_mem }}';
            
            const comment = `## Performance Benchmark Results
            
            ### Indexing Performance
            
            | Dataset Size | Bright | Meilisearch | Winner |
            |-------------|--------|-------------|---------|
            | 1,000 docs | ${b1kIdx}ms | ${m1kIdx}ms | ${Number(b1kIdx) < Number(m1kIdx) ? 'Bright' : 'Meilisearch'} |
            | 5,000 docs | ${b5kIdx}ms | ${m5kIdx}ms | ${Number(b5kIdx) < Number(m5kIdx) ? 'Bright' : 'Meilisearch'} |
            | 10,000 docs | ${b10kIdx}ms | ${m10kIdx}ms | ${Number(b10kIdx) < Number(m10kIdx) ? 'Bright' : 'Meilisearch'} |
            
            ### Search Performance (avg)
            
            | Dataset Size | Bright | Meilisearch | Winner |
            |-------------|--------|-------------|---------|
            | 1,000 docs | ${b1kSearch}ms | ${m1kSearch}ms | ${Number(b1kSearch) < Number(m1kSearch) ? 'Bright' : 'Meilisearch'} |
            | 5,000 docs | ${b5kSearch}ms | ${m5kSearch}ms | ${Number(b5kSearch) < Number(m5kSearch) ? 'Bright' : 'Meilisearch'} |
            | 10,000 docs | ${b10kSearch}ms | ${m10kSearch}ms | ${Number(b10kSearch) < Number(m10kSearch) ? 'Bright' : 'Meilisearch'} |
            
            ### Memory Usage
            
            | Dataset Size | Bright | Meilisearch | Winner |
            |-------------|--------|-------------|---------|
            | 1,000 docs | ${b1kMem}MB | ${m1kMem}MB | ${Number(b1kMem) < Number(m1kMem) ? 'Bright' : 'Meilisearch'} |
            | 5,000 docs | ${b5kMem}MB | ${m5kMem}MB | ${Number(b5kMem) < Number(m5kMem) ? 'Bright' : 'Meilisearch'} |
            | 10,000 docs | ${b10kMem}MB | ${m10kMem}MB | ${Number(b10kMem) < Number(m10kMem) ? 'Bright' : 'Meilisearch'} |
            
            <details>
            <summary>Test Configuration</summary>
            
            - **Search Queries**: laptop, computer, complex filter
            - **Platform**: Linux AMD64 (self-hosted)
            - **Meilisearch Version**: v1.33.1
            
            </details>
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            benchmark_results/
            benchmark_output.txt
          retention-days: 30
      
      - name: Comment on commit
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const b1kIdx = '${{ steps.results.outputs.bright_1k_idx }}';
            const b5kIdx = '${{ steps.results.outputs.bright_5k_idx }}';
            const b10kIdx = '${{ steps.results.outputs.bright_10k_idx }}';
            const m1kIdx = '${{ steps.results.outputs.meili_1k_idx }}';
            const m5kIdx = '${{ steps.results.outputs.meili_5k_idx }}';
            const m10kIdx = '${{ steps.results.outputs.meili_10k_idx }}';
            
            const b1kSearch = '${{ steps.results.outputs.bright_1k_search }}';
            const b5kSearch = '${{ steps.results.outputs.bright_5k_search }}';
            const b10kSearch = '${{ steps.results.outputs.bright_10k_search }}';
            const m1kSearch = '${{ steps.results.outputs.meili_1k_search }}';
            const m5kSearch = '${{ steps.results.outputs.meili_5k_search }}';
            const m10kSearch = '${{ steps.results.outputs.meili_10k_search }}';
            
            const b1kMem = '${{ steps.results.outputs.bright_1k_mem }}';
            const b5kMem = '${{ steps.results.outputs.bright_5k_mem }}';
            const b10kMem = '${{ steps.results.outputs.bright_10k_mem }}';
            const m1kMem = '${{ steps.results.outputs.meili_1k_mem }}';
            const m5kMem = '${{ steps.results.outputs.meili_5k_mem }}';
            const m10kMem = '${{ steps.results.outputs.meili_10k_mem }}';
            
            const comment = `**Benchmark Results** (vs Meilisearch v1.33.1)
            
            **Indexing Performance**
            
            | Dataset Size | Bright | Meilisearch | Winner |
            |-------------|--------|-------------|---------|
            | 1,000 docs | ${b1kIdx}ms | ${m1kIdx}ms | ${Number(b1kIdx) < Number(m1kIdx) ? 'Bright' : 'Meilisearch'} |
            | 5,000 docs | ${b5kIdx}ms | ${m5kIdx}ms | ${Number(b5kIdx) < Number(m5kIdx) ? 'Bright' : 'Meilisearch'} |
            | 10,000 docs | ${b10kIdx}ms | ${m10kIdx}ms | ${Number(b10kIdx) < Number(m10kIdx) ? 'Bright' : 'Meilisearch'} |
            
            **Search Performance (avg)**
            
            | Dataset Size | Bright | Meilisearch | Winner |
            |-------------|--------|-------------|---------|
            | 1,000 docs | ${b1kSearch}ms | ${m1kSearch}ms | ${Number(b1kSearch) < Number(m1kSearch) ? 'Bright' : 'Meilisearch'} |
            | 5,000 docs | ${b5kSearch}ms | ${m5kSearch}ms | ${Number(b5kSearch) < Number(m5kSearch) ? 'Bright' : 'Meilisearch'} |
            | 10,000 docs | ${b10kSearch}ms | ${m10kSearch}ms | ${Number(b10kSearch) < Number(m10kSearch) ? 'Bright' : 'Meilisearch'} |
            
            **Memory Usage**
            
            | Dataset Size | Bright | Meilisearch | Winner |
            |-------------|--------|-------------|---------|
            | 1,000 docs | ${b1kMem}MB | ${m1kMem}MB | ${Number(b1kMem) < Number(m1kMem) ? 'Bright' : 'Meilisearch'} |
            | 5,000 docs | ${b5kMem}MB | ${m5kMem}MB | ${Number(b5kMem) < Number(m5kMem) ? 'Bright' : 'Meilisearch'} |
            | 10,000 docs | ${b10kMem}MB | ${m10kMem}MB | ${Number(b10kMem) < Number(m10kMem) ? 'Bright' : 'Meilisearch'} |
            `;
            
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: comment
            });
